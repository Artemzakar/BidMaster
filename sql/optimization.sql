-- ==========================================
-- ЭТАП 1: ТЯЖЕЛЫЙ ЗАПРОС (ДО ОПТИМИЗАЦИИ)
-- Сценарий: Пользователь заходит в ЛК и хочет увидеть свои крупные ставки,
-- отсортированные от новых к старым.
-- ==========================================

-- Запускаем с EXPLAIN ANALYZE, чтобы увидеть реальное время выполнения
EXPLAIN ANALYZE
SELECT bid_id, amount, bid_time
FROM bids
WHERE user_id = 55   -- Берем случайного юзера (у которого есть ставки)
  AND amount > 1000  -- Фильтр: только крупные ставки
ORDER BY bid_time DESC; -- Сортировка: сначала новые

-- ОЖИДАЕМЫЙ РЕЗУЛЬТАТ (ДО):
-- "Seq Scan on bids" (Последовательное чтение всей таблицы)
-- Execution Time: ~30-60 ms (на 200к строках)


-- ==========================================
-- ЭТАП 2: СОЗДАНИЕ ИНДЕКСА
-- Мы создаем составной B-Tree индекс.
-- Он покрывает сразу три поля:
-- 1. user_id (для быстрого поиска владельца)
-- 2. amount (для фильтрации по цене)
-- 3. bid_time (для мгновенной сортировки)
-- ==========================================

CREATE INDEX idx_bids_user_amount_time
ON bids(user_id, amount, bid_time DESC);


-- ==========================================
-- ЭТАП 3: ПРОВЕРКА (ПОСЛЕ ОПТИМИЗАЦИИ)
-- Тот же самый запрос
-- ==========================================

EXPLAIN ANALYZE
SELECT bid_id, amount, bid_time
FROM bids
WHERE user_id = 55
  AND amount > 1000
ORDER BY bid_time DESC;

-- ОЖИДАЕМЫЙ РЕЗУЛЬТАТ (ПОСЛЕ):
-- "Index Scan" или "Bitmap Heap Scan" (Точечный поиск)
-- Execution Time: ~0.05 - 0.5 ms
-- УСКОРЕНИЕ: в 50-100 раз!